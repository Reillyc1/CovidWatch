<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CovidWatch - Contact Tracing</title>
    <link rel="stylesheet" href="stylesheets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="javascripts/home.js"></script>
    <script src="javascripts/login.js"></script>
    <!-- Mapbox for interactive COVID hotspot map -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css" rel="stylesheet">
</head>
<body onload="showHide()">
    <div id="site">
        <header>
            <a href="/">
                <img class="logo" src="project_logo.png" alt="CovidWatch">
            </a>
            <h1></h1>
            <!-- Navigation buttons shown when logged out -->
            <button type="button" class="right logged_out"><a href="/signup.html">Sign Up</a></button>
            <button type="button" class="right logged_out"><a href="/login.html">Login</a></button>
            <!-- User dropdown menu shown when logged in -->
            <div class="dropdown logged_in">
                <button type="button" class="dropbtn right" onclick="dropdown()">
                    <i class="fa fa-user"></i>
                </button>
                <div id="myDropdown" class="dropdown-content">
                    <a class="inner" href="/account">Account</a>
                    <button class="inner" onclick="logout()">Logout</button>
                </div>
            </div>
        </header>

        <main id="main">
            <!-- Venue Check-in Section (shown when logged in) -->
            <div class="logged_in check-in-section">
                <h2>Venue Check-In</h2>
                <p class="check-in-description">Enter the venue's unique code to record your visit for contact tracing.</p>
                <div class="check-in-form">
                    <input type="text" placeholder="Enter Venue Code (e.g., ABC123)" id="check_in" maxlength="10" required>
                    <button class="check_in_btn" onclick="check_ins()">
                        <i class="fa fa-check"></i> Check In
                    </button>
                </div>
            </div>

            <!-- Interactive Map Section -->
            <div class="container">
                <h2>COVID-19 Hotspot Map</h2>
                <div id="map"></div>
                <div id="map-loading" style="text-align: center; padding: 20px; display: none;">
                    <p>Loading map...</p>
                </div>
                <div id="map-error" style="text-align: center; padding: 20px; color: #990000; display: none;">
                    <p>Map unavailable. Please log in to view the COVID-19 hotspot map.</p>
                </div>
                <script>
                    // Mapbox initialization with secure token loading
                    // Token is fetched from server to prevent client-side exposure
                    (function() {
                        var mapContainer = document.getElementById('map');
                        var loadingEl = document.getElementById('map-loading');
                        var errorEl = document.getElementById('map-error');

                        function initMap(token) {
                            mapboxgl.accessToken = token;
                            var map = new mapboxgl.Map({
                                container: 'map',
                                style: 'mapbox://styles/mapbox/streets-v11',
                                center: [133.7751, -25.2744],
                                zoom: 3
                            });
                            var nav = new mapboxgl.NavigationControl();
                            map.addControl(nav, 'top-left');
                            var marker = new mapboxgl.Marker({
                                color: "#990000"
                            }).setLngLat([144.9631, -37.8136])
                              .addTo(map);

                            loadingEl.style.display = 'none';
                            mapContainer.style.display = 'block';
                        }

                        function showError() {
                            loadingEl.style.display = 'none';
                            mapContainer.style.display = 'none';
                            errorEl.style.display = 'block';
                        }

                        // Fetch token from server
                        loadingEl.style.display = 'block';
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', '/api/config/mapbox', true);
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200) {
                                    try {
                                        var response = JSON.parse(xhr.responseText);
                                        if (response.token) {
                                            initMap(response.token);
                                        } else {
                                            showError();
                                        }
                                    } catch (e) {
                                        showError();
                                    }
                                } else {
                                    showError();
                                }
                            }
                        };
                        xhr.send();
                    })();
                </script>
            </div>

            <hr>

            <!-- COVID News Section -->
            <section class="news-section">
                <h2>Latest COVID-19 News</h2>
                <div class="covid_news">
                    <div class="column">
                        <img src="images/covid_new2.png" alt="COVID-19 News Update">
                    </div>
                    <div class="column">
                        <img src="images/covid_news.png" alt="COVID-19 Information">
                    </div>
                    <div class="column">
                        <button class="button view-more-btn">View More News</button>
                    </div>
                </div>
            </section>

            <hr>

            <!-- Health Centers Section -->
            <section class="health-section">
                <h2>Nearby Health Centers</h2>
                <div class="covid_news">
                    <div class="column">
                        <img src="images/health_center1.png" alt="Health Center">
                    </div>
                    <div class="column">
                        <img src="images/health_center2.png" alt="Testing Location">
                    </div>
                    <div class="column">
                        <img src="images/health_3.jpg" alt="Medical Facility">
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <a href="#contact"><i class="fa fa-fw fa-envelope"></i> Contact</a>
            <a href="#about">About</a>
            <a href="#faqs">FAQs</a>
        </footer>
    </div>
</body>
</html>
